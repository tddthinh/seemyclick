<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title></title>
    <!-- Vendor CSS -->
    <link rel="stylesheet" href="assets/css/all.min.css" />
    <link rel="stylesheet" href="assets/css/roboto-font.css" />
    <link rel="stylesheet" href="assets/css/mdb.min.css" />
    <link rel="stylesheet" href="assets/jquery-ui-1.14.1/jquery-ui.css" />
    <link rel="stylesheet" href="assets/select-1.3.2/pqselect.min.css" />
    <link rel="stylesheet" href="assets/grid-3.5.1/pqgrid.min.css" />
    <link rel="stylesheet" href="assets/grid-3.5.1/pqgrid.ui.min.css" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/custom/comm-ui.css" />
    <link rel="stylesheet" href="assets/css/custom/comm-pq-grid.css" />
    <link rel="stylesheet" href="assets/css/custom/toast.css" />
    <style>
        html {
            height: 100%;
        }
        body {
            height: 100%;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-size: 14px;
        }
        .footer {
            background-color: #f0f0f0;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="fluid-container px-3 pt-1 pb-3 h-100 d-flex flex-column">
        <div class="header"></div>
        <ul class="nav nav-tabs mb-3" id="tab-menu" role="tablist">
            <li class="nav-item" role="presentation">
                <a data-mdb-tab-init id="tab-action-menu" href="#tab-action-content" role="tab" aria-controls="tab-action-content" aria-selected="true" class="nav-link active">
                    <i class="fas fa-robot"></i>
                    Action
                </a>
              </li>
              <li class="nav-item" role="presentation">
                <a data-mdb-tab-init id="tab-log-menu"    href="#tab-log-content" role="tab" aria-controls="tab-log-content" aria-selected="false" class="nav-link">
                    <i class="far fa-file-lines"></i>
                    Log
                </a>
              </li>
        </ul>
        <div class="tab-content flex-fill" id="tab-content">
            <div class="tab-pane fade show active h-100" id="tab-action-content" role="tabpanel" aria-labelledby="tab-action-menu">
                <div class="grid-container d-flex flex-column h-100">
                    <div class="toolbar">
                        <div class="mt-1 d-flex align-items-start">
                            <button id="btnStart" type="button" class="btn btn-success me-1" data-mdb-ripple-init data-mdb-tooltip-init title="Start actions"><i class="fas fa-circle-play"></i> Start</button>
                            <button id="btnLoad" type="button" class="btn btn-primary me-1" data-mdb-ripple-init data-mdb-tooltip-init title="Load action file"><i class="fas fa-file-import"></i> Load</button>
                            <button id="btnSave" type="button" class="btn btn-primary me-1" data-mdb-ripple-init data-mdb-tooltip-init title="Save action file"><i class="fas fa-sd-card"></i> Save</button>
                            <button id="btnSaveTo" type="button" class="btn btn-primary me-1" data-mdb-ripple-init data-mdb-tooltip-init title="Export to another action file"><i class="fas fa-file-export"></i> Export</button>
                        </div>
                        <div class="d-flex mt-3">
                            <div class="form-check me-3">
                                <input id="chkLoopActions" class="form-check-input" type="checkbox" value=""/>
                                <label class="form-check-label" for="chkLoopActions">Loop Actions</label>
                            </div>
                            <div class="form-check">
                                <input id="chkRefreshLog" class="form-check-input" type="checkbox" value=""/>
                                <label class="form-check-label" for="chkRefreshLog">Refresh Log</label>
                            </div>
                        </div>
                    </div>
                    <div id="gridVars"></div>
                    <div class="d-flex mt-3">
                        <h6>Loop count: <span id="lblLoopCount" class="badge badge-primary">0</span></h6>
                    </div>
                    <div class="flex-fill" id="gridActions"></div>
                </div>
            </div>
            <div class="tab-pane fade" id="tab-log-content" role="tabpanel" aria-labelledby="tab-log-menu">
                Tab 2 content
            </div>
        </div>
        <div class="footer"></div>
    </div>
    <!-- Vendor JS -->
    <script type="text/javascript" src="assets/js/lodash.js"></script>
    <script type="text/javascript" src="assets/js/mdb.umd.min.js"></script>
    <script src="assets/js/jquery-3.7.1.min.js"></script>
    <script src="assets/jquery-ui-1.14.1/jquery-ui.min.js"></script>
    <script src="assets/select-1.3.2/pqselect.min.js"></script>
    <script src="assets/grid-3.5.1/pqgrid.min.js"></script>
    <!-- Custom JS -->
    <script src="assets/js/custom/constant.js"></script>
    <script src="assets/js/custom/common-ui.js"></script>
    <script src="assets/js/custom/common-pqgrid.js"></script>
    <script src="assets/js/custom/toast.js"></script>
    <script>
        var gridActions;
        var gridVars;
        (function(user){
            window.addEventListener('pywebviewready', function () {
                user.initGridVars();
                user.initGridActions();
            });
            $(document).ready(function () {
                commonUI.init();
                user.bindEvents();
            });
        })({
            bindEvents: function() {
                $('#btnStart').on('click', function(evt) {
                    console.log('Start button clicked');
                });
                $('#btnLoad').on('click', async function(evt) {
                    commonUI.showLoading();
                    let result = await pywebview.api.load_file();
                    if(!result.success){
                        toast.info('Load File', result.message, 2500);
                        commonUI.hideLoading();
                        return;
                    }
                    console.log('Load file', result);

                    let content = result.data.content;

                    let actions = content.actions || [];
                    gridActions.option("dataModel.data", actions);
                    gridActions.refreshDataAndView();

                    let variables = content.variables || [];
                    gridVars.option("dataModel.data", variables);
                    gridVars.refreshDataAndView();
                    commonUI.hideLoading();

                    let loopActions = content.loop || false;
                    $('#chkLoopActions').prop('checked', loopActions);

                    let refreshLog = content.refresh_log || false;
                    $('#chkRefreshLog').prop('checked', refreshLog);

                    toast.show({
                        type: 'success',
                        title: 'Load File', message: `Loaded: ${actions.length} actions, ${variables.length} variables`, duration: 5000,
                    });
                });
                $('#btnSave').on('click', function(evt) {
                    console.log('Save button clicked');
                });
                $('#btnSaveTo').on('click', function(evt) {
                    console.log('Save To button clicked');
                });
                $('#chkLoopActions').on('change', function(evt) {
                    let checked = $(evt.target).is(':checked');
                    console.log('Loop Actions checkbox changed', checked);
                });
                $('#chkRefreshLog').on('change', function(evt) {
                    let checked = $(evt.target).is(':checked');
                    console.log('Refresh Log checkbox changed', checked);
                });
            },
            initGridActions: async function() {
                function isEditable(ui) {
                    const dataIndx = ui.dataIndx;

                    switch (dataIndx) {
                        case 'state' || 'disabled':
                            return true;
                        case 'running' || 'count' || 'last_time':
                            return false;
                        case 'type':
                            return true;
                        default:
                            const rowType = ui.rowData?.type;
                            if (!rowType) return false;

                            const fields = actionTypeFields[rowType];
                            if (!fields) return false;

                            return fields.required[dataIndx] === 1 || fields.optional[dataIndx] === 1;
                    }
                }

                function isRequired(ui) {
                    const dataIndx = ui.dataIndx;
                    const rowType = ui.rowData?.type;

                    if (!rowType) return false;

                    const fields = actionTypeFields[rowType];
                    if (!fields) return false;

                    switch (dataIndx) {
                        case 'state':
                        case 'running':
                        case 'count':
                        case 'last_time':
                            return false;

                        default:
                            return fields.required[dataIndx] === 1;
                    }
                }

                function renderCell(ui) {
                    const dataIndx = ui.dataIndx;
                    let text = ui.cellData;
                    let cls = "";

                    if (isRequired(ui)) {
                        cls = CELL_CLASS.REQUIRED;
                    }
                    if (!isEditable(ui)) {
                        cls = CELL_CLASS.DISABLED;
                    }
                    switch (dataIndx) {
                        case 'type':
                            const typeOptions = [
                                { id: "wait", label: "Wait" },
                                { id: "click", label: "Click" },
                                { id: "input", label: "Input" },
                                { id: "close_windows", label: "Close Windows" },
                                { id: "remove_folder", label: "Remove Folder" },
                                { id: "start_process", label: "Start Process" },
                                { id: "activate_window", label: "Activate Window" },
                                { id: "save_file", label: "Save File" },
                                { id: "resize_window", label: "Resize Window" },
                                { id: "minimize_window", label: "Minimize Window" },
                                { id: "retry_group", label: "Retry Group" },
                                { id: "call_function", label: "Call Function" },
                                { id: "_keep_variables", label: "Keep Variables" },
                                { id: "_begin_loop", label: "Begin Loop" },
                                { id: "_break_loop", label: "Break Loop" },
                            ];
                            const typeOption = typeOptions.find(opt => opt.id === ui.cellData);
                            text = typeOption ? typeOption.label : ui.cellData;
                            break;

                        case 'mode':
                            const modeOptions = [
                                { id: "", label: "" },
                                { id: "a", label: "Append" },
                                { id: "w", label: "Overwrite" },
                            ];
                            const modeOption = modeOptions.find(opt => opt.id === ui.cellData);
                            text = modeOption ? modeOption.label : ui.cellData;
                            break;
                    }

                    return { text: text, cls: cls };
                }
                
                const actionTypeFields = {
                    wait: {
                        required: { "function_image": 1 },
                        optional: {
                            "name": 1,
                            "window_title": 1,
                            "pre_delay": 1,
                            "post_delay": 1,
                            "can_fail": 1,
                            "timeout": 1,
                            "check_interval": 1,
                            "confidence": 1,
                            "disabled": 1,
                            "save_as": 1,
                            "condition": 1,
                            "try_times": 1
                        }},
                    click: {
                        required: { "function_image": 1 },
                        optional: {
                            "name": 1,
                            "window_title": 1,
                            "pre_delay": 1,
                            "post_delay": 1,
                            "can_fail": 1,
                            "offset": 1,
                            "confidence": 1,
                            "disabled": 1,
                            "save_as": 1,
                            "condition": 1,
                            "try_times": 1
                        }},
                    input: {
                        required: { "args_text": 1 },
                        optional: {
                            "name": 1,
                            "pre_delay": 1,
                            "post_delay": 1,
                            "can_fail": 1,
                            "disabled": 1,
                            "save_as": 1,
                            "condition": 1,
                            "try_times": 1
                        }},
                    close_windows: {
                        required: { "window_title": 1 },
                        optional: {
                            "name": 1,
                            "pre_delay": 1,
                            "post_delay": 1,
                            "can_fail": 1,
                            "disabled": 1,
                            "save_as": 1,
                            "condition": 1,
                            "try_times": 1
                        }},
                    remove_folder: {
                        required: { "args_text": 1 },
                        optional: {
                            "name": 1,
                            "pre_delay": 1,
                            "post_delay": 1,
                            "can_fail": 1,
                            "disabled": 1,
                            "save_as": 1,
                            "condition": 1,
                            "try_times": 1
                        }},
                    start_process: {
                        required: { "args_text": 1 },
                        optional: {
                            "name": 1,
                            "pre_delay": 1,
                            "post_delay": 1,
                            "can_fail": 1,
                            "disabled": 1,
                            "save_as": 1,
                            "condition": 1,
                            "try_times": 1
                        }},
                    activate_window: {
                        required: { "window_title": 1 },
                        optional: {
                            "name": 1,
                            "pre_delay": 1,
                            "post_delay": 1,
                            "can_fail": 1,
                            "disabled": 1,
                            "save_as": 1,
                            "condition": 1,
                            "try_times": 1
                        }},
                    save_file: {
                        required: { "args_text": 1, "content": 1 },
                        optional: {
                            "name": 1,
                            "pre_delay": 1,
                            "post_delay": 1,
                            "can_fail": 1,
                            "mode": 1,
                            "disabled": 1,
                            "save_as": 1,
                            "condition": 1,
                            "try_times": 1
                        }},
                    resize_window: {
                        required: { "window_title": 1, "args_text": 1 },
                        optional: {
                            "name": 1,
                            "pre_delay": 1,
                            "post_delay": 1,
                            "can_fail": 1,
                            "disabled": 1,
                            "save_as": 1,
                            "condition": 1,
                            "try_times": 1
                        }},
                    minimize_window: {
                        required: { "window_title": 1 },
                        optional: {
                            "name": 1,
                            "pre_delay": 1,
                            "post_delay": 1,
                            "can_fail": 1,
                            "disabled": 1,
                            "save_as": 1,
                            "condition": 1,
                            "try_times": 1
                        }},
                    retry_group: {
                        required: { "args_text": 1, "condition": 1 },
                        optional: {
                            "name": 1,
                            "pre_delay": 1,
                            "post_delay": 1,
                            "can_fail": 1,
                            "disabled": 1,
                            "save_as": 1,
                            "try_times": 1
                        }},
                    call_function: {
                        required: { "function_image": 1, "args_text": 1 },
                        optional: {
                            "name": 1,
                            "pre_delay": 1,
                            "post_delay": 1,
                            "can_fail": 1,
                            "disabled": 1,
                            "save_as": 1,
                            "condition": 1,
                            "try_times": 1
                        }},
                    _keep_variables: {
                        required: {},
                        optional: {
                            "disabled": 1,
                            "condition": 1,
                            "can_fail": 1
                        }},
                    _begin_loop: {
                        required: {},
                        optional: {
                            "disabled": 1,
                            "condition": 1,
                            "can_fail": 1
                        }},
                    _break_loop: {
                        required: {},
                        optional: {
                            "disabled": 1,
                            "condition": 1,
                            "can_fail": 1
                        }}
                };
                const columnActionsModel = [
                    {   dataIndx: "state", title: "",
                        maxWidth: 50,
                        minWidth: 50,
                        resizable: false,
                        editable: isEditable,
                        align: "center",
                        sortable: false,
                        editor: false,
                        type: 'checkbox',
                        dataType: 'bool',
                        cb: { all: false, header: true, check: true, uncheck: false },
                        properties: { default_value: false, prevent_copy_value: true },},

                    {   dataIndx: "running", title: "Running",
                        width: 80,
                        type: 'checkbox',
                        align: "center",
                        editable: isEditable,
                        editor: false,
                        dataType: 'bool',
                        cb: { all: false, header: false, check: true, uncheck: false },
                        properties: { default_value: false, prevent_copy_value: true },
                        cls: CELL_CLASS.DISABLED},

                    {   dataIndx: "count", title: "Count",
                        align: "center",
                        editable: isEditable,
                        width: 60,
                        dataType: 'integer',
                        cls: CELL_CLASS.DISABLED,
                        properties: { default_value: null, prevent_copy_value: true }},

                    {   dataIndx: "last_time", title: "Last Time",
                        align: "center",
                        editable: isEditable,
                        width: 130,
                        dataType: 'string',
                        cls: CELL_CLASS.DISABLED,
                        properties: { default_value: null, prevent_copy_value: true }},

                    {   dataIndx: "disabled", title: "Disabled",
                        width: 80,
                        align: "center",
                        editable: isEditable,
                        editor: false,
                        type: 'checkbox',
                        dataType: 'bool',
                        properties: { default_value: false },
                        cb: { all: false, header: true, check: true, uncheck: false }},

                    {   dataIndx: "name", title: "Name",
                        width: 120,
                        editable: isEditable,
                        dataType: 'string',
                        properties: { default_value: "" },
                        render: renderCell},

                    {   dataIndx: "condition", title: "Condition",
                        align: "left",
                        width: 150,
                        editable: isEditable,
                        dataType: 'string',
                        properties: { default_value: "" },
                        render: renderCell},

                    {   dataIndx: "type", title: "Type",
                        width: 180,
                        align: "center",
                        editable: isEditable,
                        dataType: 'string',
                        editor: { type: "select", valueIndx: "value", labelIndx: "label", listeners: ['change'], options: [
                                    { value: "wait", label: "Wait" },
                                    { value: "click", label: "Click" },
                                    { value: "input", label: "Input" },
                                    { value: "close_windows", label: "Close Windows" },
                                    { value: "remove_folder", label: "Remove Folder" },
                                    { value: "start_process", label: "Start Process" },
                                    { value: "activate_window", label: "Activate Window" },
                                    { value: "save_file", label: "Save File" },
                                    { value: "resize_window", label: "Resize Window" },
                                    { value: "minimize_window", label: "Minimize Window" },
                                    { value: "retry_group", label: "Retry Group" },
                                    { value: "call_function", label: "Call Function" },
                                    { value: "_keep_variables", label: "Keep Variables" },
                                    { value: "_begin_loop", label: "Begin Loop" },
                                    { value: "_break_loop", label: "Break Loop" },
                                ],
                        },
                        properties: { default_value: "click" },
                        render: renderCell},

                    {   dataIndx: "function_image", title: "Function/Image",
                        width: 150,
                        editable: isEditable,
                        dataType: 'string',
                        properties: { default_value: "" },
                        render: renderCell},

                    {   dataIndx: "args_text", title: "Arguments",
                        align: "left",
                        width: 200,
                        editable: isEditable,
                        dataType: 'string',
                        properties: { default_value: "" },
                        render: renderCell},

                    {   dataIndx: "save_as", title: "Save As",
                        width: 120,
                        align: "center",
                        editable: isEditable,
                        dataType: 'string',
                        properties: { default_value: "" },
                        render: renderCell},

                    {   dataIndx: "window_title", title: "Window Title",
                        width: 150,
                        align: "center",
                        editable: isEditable,
                        dataType: 'string',
                        properties: { default_value: "" },
                        render: renderCell},

                    {   dataIndx: "pre_delay", title: "Pre Delay",
                        width: 80,
                        align: "center",
                        editable: isEditable,
                        dataType: 'float',
                        properties: { default_value: 0.0 },
                        render: renderCell},
                        
                    {   dataIndx: "post_delay", title: "Post Delay",
                        width: 80,
                        align: "center",
                        editable: isEditable,
                        dataType: 'float',
                        properties: { default_value: 0.0 },
                        render: renderCell},

                    {   dataIndx: "can_fail", title: "Can Fail",
                        width: 80,
                        align: "center",
                        editable: isEditable,
                        editor: false,
                        type: 'checkbox',
                        dataType: 'bool',
                        cb: { all: false, header: true, check: true, uncheck: false },
                        properties: { default_value: false }},

                    {   dataIndx: "try_times", title: "Try Times",
                        width: 80,
                        align: "center",
                        editable: isEditable,
                        dataType: 'integer',
                        properties: { default_value: 1 },
                        render: renderCell},

                    {   dataIndx: "timeout", title: "Timeout",
                        width: 80,
                        align: "center",
                        editable: isEditable,
                        dataType: 'float',
                        properties: { default_value: 0.0 },
                        render: renderCell},

                    {   dataIndx: "check_interval", title: "Check Interval",
                        width: 100,
                        align: "center",
                        editable: isEditable,
                        dataType: 'float',
                        properties: { default_value: 0.0 },
                        render: renderCell},

                    {   dataIndx: "confidence", title: "Confidence",
                        width: 100,
                        align: "center",
                        editable: isEditable,
                        dataType: 'float',
                        properties: { default_value: 0.8 },
                        render: renderCell},

                    {   dataIndx: "offset", title: "Offset",
                        width: 80,
                        align: "center",
                        editable: isEditable,
                        dataType: 'string',
                        properties: { default_value: "0,0" },
                        render: renderCell},

                    {   dataIndx: "mode", title: "Mode",
                        width: 100,
                        align: "center",
                        editable: isEditable,
                        dataType: 'string',
                        editor: { type: "select", valueIndx: "value", labelIndx: "label", listeners: ['change'], options: [
                                    { value: "", label: "" },
                                    { value: "a", label: "Append" },
                                    { value: "w", label: "Overwrite" },
                                ]
                        },
                        properties: { default_value: "" },
                        render: renderCell},

                    {   dataIndx: "content", title: "Content",
                        width: 200,
                        dataType: 'string',
                        editor: { type: 'textarea' },
                        properties: { default_value: "" },
                        render: renderCell},

                ]
                const gridActionsOptions = {
                    width: '100%',
                    height: 350,
                    colModel: columnActionsModel,
                    dataModel: { data: [] },
                    selectionModel: { type: 'cell', mode: 'block' },
                    sortable: true,
                    columnTemplate: {type: "text", halign: "center", hvalign: "center", align: "center", valign: "center", resizable: true},
                    postRenderInterval: 200,
                    filterModel: { on: true, mode: "AND", header: true },
                    numberCell: { show: true },
                    title: "Actions",
                    scrollModel: {autoFit: false, pace: 'fast'},
                    resizable: true,
                    swipeModel: {on: false},
                    wrap: false,
                    hwrap: false,
                    virtualX: true,
                    virtualY: true,
                    editModel: {clicksToEdit: 2},
                    collapsible: { on : false },
                    resizable: false,
                    toolbar: {
                        items: [
                            {   button: "add",
                                listener: function () {
                                    let colModel = gridActions.option("colModel");
                                    let newRow = {};
                                    colModel.forEach(col => {
                                        newRow[col.dataIndx] = col.properties?.default_value;
                                    });
                                    gridActions.addRow({newRow: newRow, refresh: true, checkEditable: false});
                                }},

                            {   button: "delete",
                                listener: function () {
                                    let selectedRows = gridActions.getData().flatMap((e,i)=>({state: e.state, rowIndx: i})).filter(e=>e.state);
                                    if(selectedRows.length > 0){
                                        gridActions.deleteRow({rowList: selectedRows});
                                    } else {
                                        alert('No rows selected to delete');
                                    }
                                }},

                            {   button: "copy",
                                listener: function () {
                                    let colModel = gridActions.option("colModel");
                                    let selectedRows = gridActions.getData().filter(e=>e.state);
                                    if(selectedRows.length > 0){
                                        let len = gridActions.getData().length;
                                        let rowList = [];
                                        selectedRows.forEach(row => {
                                            row.state = false;

                                            let clonedRow = _.cloneDeep(row);
                                            colModel.forEach(col => {
                                                if(col.properties?.prevent_copy_value){
                                                    clonedRow[col.dataIndx] = col.properties?.default_value;
                                                }
                                            });
                                            rowList.push({rowIndx: len++, newRow: clonedRow});
                                        });

                                        gridActions.addRow({rowList:rowList});
                                    } else {
                                        alert('No rows selected to copy');
                                    }
                                }},

                            {   button: "screenshot",
                                listener: async function (evt) {
                                    $button = $(evt.target).parent();
                                    $button.attr('disabled','true');
                                    let result = await pywebview.api.capture_screenshot();
                                    $button.attr('disabled',null);
                                    if(!result.success){
                                        toast.info('Screenshot', 'No image saved', 2500);
                                        return;
                                    }
                                    let path = result.data.path;
                                    toast.show({
                                        type: 'success',
                                        title: 'Screenshot',
                                        message: 'Saved to ' + path,
                                        duration: 5000,
                                        buttons: [
                                            {
                                                text: 'Open Folder',
                                                noDefaultClass: true,
                                                class: 'btn btn-secondary',
                                                attribute: "data-mdb-ripple-init",
                                                onClick: async function () {
                                                    let result = await pywebview.api.open_folder(path);
                                                    if(!result.success){
                                                        toast.error('Open Folder', result.message, 2500);
                                                        return;
                                                    }
                                                }
                                            },
                                        ]
                                    });
                                }}
                        ]
                    },
                    cellSave: function (evt, ui) {
                        if (ui.dataIndx === 'type') {
                            gridActions.refreshView();
                        }
                    },
                    change: function (evt, ui) {
                        let grid = this;
                        let checkboxDataIndxList = grid.options.colModel.filter(e=>e.type === 'checkbox').flatMap(e=>e.dataIndx);
                        let changedDataIndxList = _.uniq(ui.rowList.flatMap(e=>_.keys(e.newRow)));
                        let isCheckboxChanged = changedDataIndxList.length == 1 && checkboxDataIndxList.includes(changedDataIndxList[0]);
                        if(isCheckboxChanged) return;
                        commonPQGrid.filter.refresh(grid, changedDataIndxList);

                    }
                };

                gridActions = commonPQGrid.init("#gridActions", gridActionsOptions);
            },
            initGridVars: async function () {
                const columnVarsModel = [
                    {   dataIndx: "state", title: "",
                        maxWidth: 30,
                        minWidth: 30,
                        resizable: false,
                        type: 'checkbox',
                        align: "center",
                        sortable: false,
                        editor: false,
                        dataType: 'bool',
                        cb: { all: false, header: true, check: true, uncheck: false }},

                    {   dataIndx: "name", title: "Variable Name",
                        width: 120,
                        properties: { default_value: "" }},

                    {   dataIndx: "value", title: "Current Value",
                        width: 150,
                        editable: false,
                        cls: CELL_CLASS.DISABLED,
                        properties: { default_value: "", prevent_copy_value: true }},

                    {   dataIndx: "step", title: "Changed By Step",
                        width: 120,
                        editable: false,
                        cls: CELL_CLASS.DISABLED,
                        properties: { default_value: "", prevent_copy_value: true }},

                    {   dataIndx: "default_value", title: "Default Value",
                        width: 120,
                        properties: { default_value: "" }},
                ]
                const gridVarsOptions = {
                    width: '100%',
                    height: 200,
                    colModel: columnVarsModel,
                    dataModel: {data: []},
                    editable: true,
                    selectionModel: {type: 'cell', mode: 'block'},
                    sortable: true,
                    columnTemplate: {type: "text", halign: "center", hvalign: "center", align: "center", valign: "center", resizable: true},
                    postRenderInterval: 200,
                    filterModel: {on: true, mode: "AND", header: true},
                    numberCell: {show: true},
                    title: "Variables",
                    scrollModel: {autoFit: false},
                    resizable: true,
                    swipeModel: {on: false},
                    wrap: false,
                    hwrap: false,
                    editModel: {clicksToEdit: 2},
                    collapsible: {
                        on : true,
                        expand: function(evt, ui){
                            if(gridActions){
                                gridActions.refresh();
                            }
                        },
                        collapse: function(evt, ui){
                            if(gridActions){
                                gridActions.refresh();
                            }
                        }
                    },
                    toolbar: {
                        items: [
                            {   button: 'add',
                                listener: function () {
                                    let colModel = gridVars.option("colModel");
                                    let newRow = {};
                                    colModel.forEach(col => {
                                        newRow[col.dataIndx] = col.properties?.default_value;
                                    });
                                    gridVars.addRow({newRow: newRow, refresh: true, checkEditable: false});
                                }},
                            {   button: 'delete',
                                listener: function () {
                                    let selectedRows = gridVars.getData().flatMap((e,i)=>({state: e.state, rowIndx: i})).filter(e=>e.state);
                                    if(selectedRows.length > 0){
                                        gridVars.deleteRow({rowList: selectedRows});
                                    } else {
                                        alert('No rows selected to delete');
                                    }
                                }},
                            {   button: 'copy',
                                listener: function () {
                                    let colModel = gridVars.option("colModel");
                                    let selectedRows = gridVars.getData().filter(e=>e.state);
                                    if(selectedRows.length > 0){
                                        let len = gridVars.getData().length;
                                        let rowList = [];
                                        selectedRows.forEach(row => {
                                            row.state = false;

                                            let clonedRow = _.cloneDeep(row);
                                            colModel.forEach(col => {
                                                if(col.properties?.prevent_copy_value){
                                                    clonedRow[col.dataIndx] = col.properties?.default_value;
                                                }
                                            });
                                            rowList.push({rowIndx: len++, newRow: clonedRow});
                                        });

                                        gridVars.addRow({rowList:rowList});
                                    } else {
                                        alert('No rows selected to copy');
                                    }
                                }},
                        ]
                    },
                };
                gridVars = commonPQGrid.init("#gridVars", gridVarsOptions);
            }
        })
    </script>
</body>

</html>