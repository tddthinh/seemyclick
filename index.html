<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>SeeMyMacro</title>
    <!-- Vendor CSS -->
    <link rel="stylesheet" href="assets/css/all.min.css" />
    <link rel="stylesheet" href="assets/css/roboto-font.css" />
    <link rel="stylesheet" href="assets/css/mdb.min.css" />
    <link rel="stylesheet" href="assets/jquery-ui-1.14.1/jquery-ui.css" />
    <link rel="stylesheet" href="assets/select-1.3.2/pqselect.min.css" />
    <link rel="stylesheet" href="assets/grid-3.5.1/pqgrid.min.css" />
    <link rel="stylesheet" href="assets/grid-3.5.1/pqgrid.ui.min.css" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/custom/comm-pq-grid.css" />
    <link rel="stylesheet" href="assets/css/custom/toast.css" />
    <style>
        html {
            height: 100%;
        }

        body {
            height: 100%;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-size: 14px;
        }

        .footer {
            height: 20px;
            background-color: #f0f0f0;
            border-top: 1px solid #e0e0e0;
            padding: 5px;
            text-align: center;
            font-size: 12px;
            color: #666;
        }

        .loading-container {
            display: none;
            position: fixed;
            z-index: 9999;
            background: white;
        }
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #ddd;
            border-top-color: #555;
            border-radius: 50%;
            animation: spin 1s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }
    </style>
</head>
<body>
    <div class="loading-container h-100 w-100">
        <div class="spinner"></div>
    </div>
    <div class="fluid-container p-3 h-100 d-flex flex-column">
        <div class="header"></div>
        <div class="grid-container flex-fill d-flex flex-column">
            <div class="toolbar">
                <div class="mt-1 d-flex align-items-start">
                    <button type="button" class="btn btn-primary me-1" data-mdb-ripple-init>Start</button>
                    <button type="button" class="btn btn-primary me-1" data-mdb-ripple-init>Load</button>
                    <button type="button" class="btn btn-primary me-1" data-mdb-ripple-init>Save</button>
                    <button type="button" class="btn btn-primary me-1" data-mdb-ripple-init>Save To</button>
                </div>
                <div class="d-flex mt-3">
                    <div class="form-check me-3">
                        <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault1" />
                        <label class="form-check-label" for="flexCheckDefault1">Loop Actions</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault2" />
                        <label class="form-check-label" for="flexCheckDefault2">Refresh Log</label>
                    </div>
                </div>
            </div>
            <hr>
            <div id="gridVars"></div>
            <div class="d-flex mt-3">
                <h6>Loop count: <span class="badge badge-primary">0</span></h6>
            </div>
            <div class="flex-fill" id="gridActions"></div>
        </div>
        <div class="footer"></div>
    </div>
    <!-- Vendor JS -->
    <script type="text/javascript" src="assets/js/lodash.js"></script>
    <script type="text/javascript" src="assets/js/mdb.umd.min.js"></script>
    <script src="assets/js/jquery-3.7.1.min.js"></script>
    <script src="assets/jquery-ui-1.14.1/jquery-ui.min.js"></script>
    <script src="assets/select-1.3.2/pqselect.min.js"></script>
    <script src="assets/grid-3.5.1/pqgrid.min.js"></script>
    <!-- Custom JS -->
    <script src="assets/js/custom/constant.js"></script>
    <script src="assets/js/custom/common-pqgrid.js"></script>
    <script src="assets/js/custom/toast.js"></script>
    <script>
        window.addEventListener('pywebviewready', function () {
            initGridVars();
            initGridActions();
        });
        var loopCount = 0;
        var gridActions;
        var gridVars;
        var gridData = [];

        async function initGridActions() {

            function isEditable(ui) {
                const dataIndx = ui.dataIndx;

                switch (dataIndx) {
                    case 'state' || 'disabled':
                        return true;
                    case 'running' || 'count' || 'last_time':
                        return false;
                    case 'type':
                        return true;
                    default:
                        const rowType = ui.rowData?.type;
                        if (!rowType) return false;

                        const fields = actionTypeFields[rowType];
                        if (!fields) return false;

                        return fields.required[dataIndx] === 1 || fields.optional[dataIndx] === 1;
                }
            }

            function isRequired(ui) {
                const dataIndx = ui.dataIndx;
                const rowType = ui.rowData?.type;

                if (!rowType) return false;

                const fields = actionTypeFields[rowType];
                if (!fields) return false;

                switch (dataIndx) {
                    case 'state':
                    case 'running':
                    case 'count':
                    case 'last_time':
                        return false;

                    default:
                        return fields.required[dataIndx] === 1;
                }
            }

            function renderCell(ui) {
                const dataIndx = ui.dataIndx;
                let text = ui.cellData;
                let cls = "";

                if (isRequired(ui)) {
                    cls = CELL_CLASS.REQUIRED;
                }
                if (!isEditable(ui)) {
                    cls = CELL_CLASS.DISABLED;
                }
                switch (dataIndx) {
                    case 'type':
                        const typeOptions = [
                            { id: "wait", label: "Wait" },
                            { id: "click", label: "Click" },
                            { id: "input", label: "Input" },
                            { id: "close_windows", label: "Close Windows" },
                            { id: "remove_folder", label: "Remove Folder" },
                            { id: "start_process", label: "Start Process" },
                            { id: "activate_window", label: "Activate Window" },
                            { id: "save_file", label: "Save File" },
                            { id: "resize_window", label: "Resize Window" },
                            { id: "minimize_window", label: "Minimize Window" },
                            { id: "retry_group", label: "Retry Group" },
                            { id: "call_function", label: "Call Function" },
                            { id: "_keep_variables", label: "Keep Variables" },
                            { id: "_begin_loop", label: "Begin Loop" },
                            { id: "_break_loop", label: "Break Loop" },
                        ];
                        const typeOption = typeOptions.find(opt => opt.id === ui.cellData);
                        text = typeOption ? typeOption.label : ui.cellData;
                        break;

                    case 'mode':
                        const modeOptions = [
                            { id: "", label: "" },
                            { id: "a", label: "Append" },
                            { id: "w", label: "Overwrite" },
                        ];
                        const modeOption = modeOptions.find(opt => opt.id === ui.cellData);
                        text = modeOption ? modeOption.label : ui.cellData;
                        break;
                }

                return { text: text, cls: cls };
            }
            
            const actionTypeFields = {
                wait: {
                    required: { "function_image": 1 },
                    optional: {
                        "name": 1,
                        "window_title": 1,
                        "pre_delay": 1,
                        "post_delay": 1,
                        "can_fail": 1,
                        "timeout": 1,
                        "check_interval": 1,
                        "confidence": 1,
                        "disabled": 1,
                        "save_as": 1,
                        "condition": 1,
                        "try_times": 1
                    }
                },
                click: {
                    required: { "function_image": 1 },
                    optional: {
                        "name": 1,
                        "window_title": 1,
                        "pre_delay": 1,
                        "post_delay": 1,
                        "can_fail": 1,
                        "offset": 1,
                        "confidence": 1,
                        "disabled": 1,
                        "save_as": 1,
                        "condition": 1,
                        "try_times": 1
                    }
                },
                input: {
                    required: { "args_text": 1 },
                    optional: {
                        "name": 1,
                        "pre_delay": 1,
                        "post_delay": 1,
                        "can_fail": 1,
                        "disabled": 1,
                        "save_as": 1,
                        "condition": 1,
                        "try_times": 1
                    }
                },
                close_windows: {
                    required: { "window_title": 1 },
                    optional: {
                        "name": 1,
                        "pre_delay": 1,
                        "post_delay": 1,
                        "can_fail": 1,
                        "disabled": 1,
                        "save_as": 1,
                        "condition": 1,
                        "try_times": 1
                    }
                },
                remove_folder: {
                    required: { "args_text": 1 },
                    optional: {
                        "name": 1,
                        "pre_delay": 1,
                        "post_delay": 1,
                        "can_fail": 1,
                        "disabled": 1,
                        "save_as": 1,
                        "condition": 1,
                        "try_times": 1
                    }
                },
                start_process: {
                    required: { "args_text": 1 },
                    optional: {
                        "name": 1,
                        "pre_delay": 1,
                        "post_delay": 1,
                        "can_fail": 1,
                        "disabled": 1,
                        "save_as": 1,
                        "condition": 1,
                        "try_times": 1
                    }
                },
                activate_window: {
                    required: { "window_title": 1 },
                    optional: {
                        "name": 1,
                        "pre_delay": 1,
                        "post_delay": 1,
                        "can_fail": 1,
                        "disabled": 1,
                        "save_as": 1,
                        "condition": 1,
                        "try_times": 1
                    }
                },
                save_file: {
                    required: { "args_text": 1, "content": 1 },
                    optional: {
                        "name": 1,
                        "pre_delay": 1,
                        "post_delay": 1,
                        "can_fail": 1,
                        "mode": 1,
                        "disabled": 1,
                        "save_as": 1,
                        "condition": 1,
                        "try_times": 1
                    }
                },
                resize_window: {
                    required: { "window_title": 1, "args_text": 1 },
                    optional: {
                        "name": 1,
                        "pre_delay": 1,
                        "post_delay": 1,
                        "can_fail": 1,
                        "disabled": 1,
                        "save_as": 1,
                        "condition": 1,
                        "try_times": 1
                    }
                },
                minimize_window: {
                    required: { "window_title": 1 },
                    optional: {
                        "name": 1,
                        "pre_delay": 1,
                        "post_delay": 1,
                        "can_fail": 1,
                        "disabled": 1,
                        "save_as": 1,
                        "condition": 1,
                        "try_times": 1
                    }
                },
                retry_group: {
                    required: { "args_text": 1, "condition": 1 },
                    optional: {
                        "name": 1,
                        "pre_delay": 1,
                        "post_delay": 1,
                        "can_fail": 1,
                        "disabled": 1,
                        "save_as": 1,
                        "try_times": 1
                    }
                },
                call_function: {
                    required: { "function_image": 1, "args_text": 1 },
                    optional: {
                        "name": 1,
                        "pre_delay": 1,
                        "post_delay": 1,
                        "can_fail": 1,
                        "disabled": 1,
                        "save_as": 1,
                        "condition": 1,
                        "try_times": 1
                    }
                },
                _keep_variables: {
                    required: {},
                    optional: {
                        "disabled": 1,
                        "condition": 1,
                        "can_fail": 1
                    }
                },
                _begin_loop: {
                    required: {},
                    optional: {
                        "disabled": 1,
                        "condition": 1,
                        "can_fail": 1
                    }
                },
                _break_loop: {
                    required: {},
                    optional: {
                        "disabled": 1,
                        "condition": 1,
                        "can_fail": 1
                    }
                }
            };
            const columnActionsModel = [
                {
                    dataIndx: "state", title: "",
                    maxWidth: 50,
                    minWidth: 50,
                    resizable: false,
                    editable: isEditable,
                    align: "center",
                    sortable: false,
                    editor: false,
                    type: 'checkbox',
                    dataType: 'bool',
                    cb: { all: false, header: true, check: true, uncheck: false },
                    properties: { default_value: false, prevent_copy_value: true },
                },
                {
                    dataIndx: "running", title: "Running",
                    width: 80,
                    type: 'checkbox',
                    align: "center",
                    editable: isEditable,
                    editor: false,
                    dataType: 'bool',
                    cb: { all: false, header: false, check: true, uncheck: false },
                    properties: { default_value: false, prevent_copy_value: true },
                    cls: CELL_CLASS.DISABLED
                },
                {
                    dataIndx: "count", title: "Count",
                    align: "center",
                    editable: isEditable,
                    width: 60,
                    dataType: 'integer',
                    cls: CELL_CLASS.DISABLED,
                    properties: { default_value: null, prevent_copy_value: true },
                    editable: isEditable,
                },
                {
                    dataIndx: "last_time", title: "Last Time",
                    align: "center",
                    editable: isEditable,
                    width: 130,
                    dataType: 'string',
                    properties: { default_value: "", prevent_copy_value: true },
                    cls: CELL_CLASS.DISABLED,
                    editable: isEditable,
                },
                {
                    dataIndx: "disabled", title: "Disabled",
                    width: 80,
                    align: "center",
                    editable: isEditable,
                    editor: false,
                    type: 'checkbox',
                    dataType: 'bool',
                    cb: { all: false, header: true, check: true, uncheck: false },
                    properties: { default_value: false },
                },
                {
                    dataIndx: "name", title: "Name",
                    width: 120,
                    editable: isEditable,
                    dataType: 'string',
                    properties: { default_value: "" },
                    render: renderCell
                },
                {
                    dataIndx: "condition", title: "Condition",
                    width: 150,
                    editable: isEditable,
                    dataType: 'string',
                    properties: { default_value: "" },
                    render: renderCell
                },
                {
                    dataIndx: "type", title: "Type",
                    width: 180,
                    align: "center",
                    editable: isEditable,
                    dataType: 'string',
                    editor: {
                        type: "select",
                        valueIndx: "value",
                        labelIndx: "label",
                        options: [
                            { value: "wait", label: "Wait" },
                            { value: "click", label: "Click" },
                            { value: "input", label: "Input" },
                            { value: "close_windows", label: "Close Windows" },
                            { value: "remove_folder", label: "Remove Folder" },
                            { value: "start_process", label: "Start Process" },
                            { value: "activate_window", label: "Activate Window" },
                            { value: "save_file", label: "Save File" },
                            { value: "resize_window", label: "Resize Window" },
                            { value: "minimize_window", label: "Minimize Window" },
                            { value: "retry_group", label: "Retry Group" },
                            { value: "call_function", label: "Call Function" },
                            { value: "_keep_variables", label: "Keep Variables" },
                            { value: "_begin_loop", label: "Begin Loop" },
                            { value: "_break_loop", label: "Break Loop" },
                        ],
                        listeners: ['change']
                    },
                    properties: { default_value: "click" },
                    render: renderCell
                },
                {
                    dataIndx: "function_image", title: "Function/Image",
                    width: 150,
                    editable: isEditable,
                    dataType: 'string',
                    properties: { default_value: "" },
                    render: renderCell
                },
                {
                    dataIndx: "args_text", title: "Arguments",
                    width: 200,
                    editable: isEditable,
                    dataType: 'string',
                    properties: { default_value: "" },
                    render: renderCell
                },
                {
                    dataIndx: "save_as", title: "Save As",
                    width: 120,
                    align: "center",
                    editable: isEditable,
                    dataType: 'string',
                    properties: { default_value: "" },
                    render: renderCell
                },
                {
                    dataIndx: "window_title", title: "Window Title",
                    width: 150,
                    align: "center",
                    editable: isEditable,
                    dataType: 'string',
                    properties: { default_value: "" },
                    render: renderCell
                },
                {
                    dataIndx: "pre_delay", title: "Pre Delay",
                    width: 80,
                    align: "center",
                    editable: isEditable,
                    dataType: 'float',
                    properties: { default_value: 0.0 },
                    render: renderCell
                },
                {
                    dataIndx: "post_delay", title: "Post Delay",
                    width: 80,
                    align: "center",
                    editable: isEditable,
                    dataType: 'float',
                    properties: { default_value: 0.0 },
                    render: renderCell
                },
                {
                    dataIndx: "can_fail", title: "Can Fail",
                    width: 80,
                    align: "center",
                    editable: isEditable,
                    editor: false,
                    type: 'checkbox',
                    dataType: 'bool',
                    cb: { all: false, header: true, check: true, uncheck: false },
                    properties: { default_value: false }
                },
                {
                    dataIndx: "try_times", title: "Try Times",
                    width: 80,
                    align: "center",
                    editable: isEditable,
                    dataType: 'integer',
                    properties: { default_value: 1 },
                    render: renderCell
                },
                {
                    dataIndx: "timeout", title: "Timeout",
                    width: 80,
                    align: "center",
                    editable: isEditable,
                    dataType: 'float',
                    properties: { default_value: 0.0 },
                    render: renderCell
                },
                {
                    dataIndx: "check_interval", title: "Check Interval",
                    width: 100,
                    align: "center",
                    editable: isEditable,
                    dataType: 'float',
                    properties: { default_value: 0.0 },
                    render: renderCell
                },
                {
                    dataIndx: "confidence", title: "Confidence",
                    width: 100,
                    align: "center",
                    editable: isEditable,
                    dataType: 'float',
                    properties: { default_value: 0.8 },
                    render: renderCell
                },
                {
                    dataIndx: "offset", title: "Offset",
                    width: 80,
                    align: "center",
                    editable: isEditable,
                    dataType: 'string',
                    properties: { default_value: "0,0" },
                    render: renderCell
                },
                {
                    dataIndx: "mode", title: "Mode",
                    width: 100,
                    align: "center",
                    editable: isEditable,
                    dataType: 'string',
                    editor: {
                        type: "select",
                        valueIndx: "value",
                        labelIndx: "label",
                        options: [
                            { value: "", label: "" },
                            { value: "a", label: "Append" },
                            { value: "w", label: "Overwrite" },
                        ]
                    },
                    properties: { default_value: "" },
                    render: renderCell
                },
                {
                    dataIndx: "content", title: "Content",
                    width: 200,
                    dataType: 'string',
                    editor: { type: 'textarea' },
                    properties: { default_value: "" },
                    render: renderCell
                },
            ]
            const gridActionsOptions = {
                width: '100%',
                height: 350,
                colModel: columnActionsModel,
                dataModel: { data: [] },
                selectionModel: { type: 'cell', mode: 'block' },
                sortable: true,
                columnTemplate: {
                    type: "text",
                    halign: "center",
                    hvalign: "center",
                    align: "center",
                    valign: "center",
                    resizable: true,
                },
                postRenderInterval: 200,
                filterModel: { on: true, mode: "AND", header: true },
                numberCell: { show: true },
                title: "Actions",
                scrollModel: { 
                    autoFit: false
                },
                resizable: true,
                swipeModel: { on: false },
                wrap: false,
                hwrap: false,
                editModel: {
                    clicksToEdit: 2
                },
                historyModel: { on: true },
                toolbar: {
                    items: [
                        {   label: 'Add', type: 'button',
                            listener: function () {
                                let colModel = gridActions.option("colModel");
                                let newRow = {};
                                colModel.forEach(col => {
                                    newRow[col.dataIndx] = col.properties?.default_value;
                                });
                                gridActions.addRow({newRow: newRow, refresh: false, checkEditable: false});
                            }
                        },
                        {   label: 'Delete', type: 'button',
                            listener: function () {
                                let selectedRows = gridActions.getData().flatMap((e,i)=>({state: e.state, rowIndx: i})).filter(e=>e.state);
                                if(selectedRows.length > 0){
                                    gridActions.deleteRow({rowList: selectedRows});
                                } else {
                                    alert('No rows selected to delete');
                                }
                            }
                        },
                        {   label: 'Copy', type: 'button',
                            listener: function () {
                                let colModel = gridActions.option("colModel");
                                let selectedRows = gridActions.getData().filter(e=>e.state);
                                if(selectedRows.length > 0){
                                    let data = gridActions.getData();
                                    selectedRows.forEach(row => {
                                        row.state = false;

                                        let clonedRow = _.cloneDeep(row);
                                        colModel.forEach(col => {
                                            if(col.properties?.prevent_copy_value){
                                                clonedRow[col.dataIndx] = col.properties?.default_value;
                                            }
                                        });
                                        data.push(clonedRow);
                                    });

                                    gridActions.option("dataModel.data", data);
                                    gridActions.refreshDataAndView();
                                } else {
                                    alert('No rows selected to copy');
                                }
                            }
                        },
                        {   label: 'Screenshot', type: 'button',
                            listener: async function (evt) {
                                $button = $(evt.target);
                                $button.button("disable");
                                let result = await pywebview.api.capture_screenshot();
                                $button.button("enable");
                                if(!result.success){
                                    toast.info('Screenshot', 'No image saved', 2500);
                                    return;
                                }
                                let path = result.data.path;
                                toast.show({
                                    type: 'success',
                                    title: 'Screenshot',
                                    message: 'Saved to ' + path,
                                    duration: 500000,
                                    buttons: [
                                        {
                                            text: 'Open Folder',
                                            noDefaultClass: true,
                                            class: 'btn btn-secondary',
                                            attribute: "data-mdb-ripple-init",
                                            onClick: function () {
                                                pywebview.api.open_folder(path);
                                            }
                                        },
                                    ]
                                });
                            }
                        }
                    ]
                },
                resizable: false,
                cellSave: function (evt, ui) {
                    if (ui.dataIndx === 'type') {
                        gridActions.refreshView();
                    }
                },
                change: function (evt, ui) {
                    let grid = this;
                    let obj = {};
                    if(ui.source === 'add'){
                        obj.header = false;
                    }
                    let checkboxDataIndxList = grid.options.colModel.filter(e=>e.type === 'checkbox').flatMap(e=>e.dataIndx);
                    let changedDataIndxList = _.uniq(ui.rowList.flatMap(e=>_.keys(e.newRow)));
                    if(changedDataIndxList.length == 1 && checkboxDataIndxList.includes(changedDataIndxList[0])){
                        obj.header = false;
                    }

                    grid.refreshDataAndView(obj);
                }
            };

            gridActions = commonPQGrid.init("#gridActions", gridActionsOptions);

            await loadDataFromPython();
        }
        async function initGridVars() {
            const columnVarsModel = [
                {
                    title: "",
                    dataIndx: "state",
                    maxWidth: 30,
                    minWidth: 30,
                    resizable: false,
                    type: 'checkbox',
                    align: "center",
                    sortable: false,
                    editor: false,
                    dataType: 'bool',
                    cb: { all: false, header: true, check: true, uncheck: false },
                },
                {
                    dataIndx: "name",
                    title: "Variable Name",
                    width: 120,
                    properties: { default_value: "" }
                },
                {
                    dataIndx: "value",
                    title: "Current Value",
                    width: 150,
                    properties: { default_value: "" }
                },
                {
                    dataIndx: "step",
                    title: "Changed By Step",
                    width: 120,
                    properties: { default_value: "" }
                },
                {
                    dataIndx: "default_value",
                    title: "Default Value",
                    width: 120,
                    properties: { default_value: "" }
                },
            ]
            const gridVarsOptions = {
                width: '100%',
                height: 200,
                colModel: columnVarsModel,
                dataModel: { data: [{ state: false, name: '', value: '', step: '', default_value: '' }] },
                editable: true,
                selectionModel: { type: 'cell', mode: 'block' },
                sortable: true,
                columnTemplate: {
                    type: "text",
                    halign: "center",
                    hvalign: "center",
                    align: "center",
                    valign: "center",
                    resizable: true,
                },
                postRenderInterval: 0,
                filterModel: { on: true, mode: "AND", header: true },
                numberCell: { show: false },
                title: "Variables",
                scrollModel: { autoFit: false },
                virtualX: true,
                virtualY: true,
                resizable: true,
                track: false, // Disable change tracking for better performance
                stripeRows: false, // Reduces rendering overhead
                swipeModel: { on: false },
                wrap: false,
                hwrap: false,
                editModel: {
                    clicksToEdit: 2
                },
                toolbar: {
                    items: [
                        {
                            type: 'button',
                            label: 'Add',
                            listener: function () {
                                console.log('Add button clicked');
                            }
                        },
                        {
                            type: 'button',
                            label: 'Delete',
                            listener: function () {
                                console.log('Delete button clicked');
                            }
                        },
                        {
                            type: 'button',
                            label: 'Copy',
                            listener: function () {
                                console.log('Copy button clicked');
                            }
                        },
                    ]
                },
            };
            gridVars = commonPQGrid.init("#gridVars", gridVarsOptions);
        }
        async function loadDataFromPython() {
            try {
                console.log('Loading data from Python backend...');
                const data = await pywebview.api.get_data();
                console.log('Received data:', data);

                gridData = data;
                gridActions.option("dataModel.data", gridData);
                gridActions.refreshDataAndView();
                showNotification(`Loaded ${data.length} rows successfully`, 'success');
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Error loading data from Python', 'error');
            }
        }

        $(document).ready(function () {

        });
        function showNotification(message, type = 'success') {
        }
    </script>
</body>

</html>